function onOpen() { 
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('üóìÔ∏è | AgendaNew')
    .addItem('Backup', 'fPrincipales')
    .addToUi();
}

function fPrincipales() {
  funcionesPrincipalesFilas();
  funcionEliminarTodo();
}

function funcionesPrincipalesFilas() {//funciona 
  // Llamadas a la funci√≥n para cada hoja de origen
  procesarYCopiarFilasAbierta("Consejo 2024- ifno");
  recorrerColumnaCompletado("Consejo 2024- ifno");
  procesarYCopiarFilasAbierta("Rosca de reyes DESPACHO - info");
  recorrerColumnaCompletado("Rosca de reyes DESPACHO - info");
  procesarYCopiarFilasAbierta("Regalos Navidad 2024- info");
  recorrerColumnaCompletado("Regalos Navidad 2024- info");
  procesarYCopiarFilasAbierta("Organizar Evento Dia de Reyes 06 Enero 2024- info");
  recorrerColumnaCompletado("Organizar Evento Dia de Reyes 06 Enero 2024- info");
  procesarYCopiarFilasAbierta("Propuesta Detalle Cumplea√±os mensual- info");
  recorrerColumnaCompletado("Propuesta Detalle Cumplea√±os mensual- info");
}


function procesarYCopiarFilasAbierta(hojaOrigenNombre) { //FUNCIONA.== ABIERTAS
  var hojaOrigen = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(hojaOrigenNombre);
  var hojaDestino = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("CONCENTRADO");

  var ultimaFilaOrigen = hojaOrigen.getLastRow();
  var ultimaFilaDestino = hojaDestino.getLastRow();

  // Definir el rango de celdas con f√≥rmulas en la hoja de origen (por ejemplo, K42:N42)
  var rangoFormulas = hojaDestino.getRange("K2:N2"); // RANGO DE ABIERTA

  // Obtener los datos y las f√≥rmulas desde la funci√≥n obtenerDatosAbierta()
  var datosARepetir = obtenerDatosAbiertas(hojaOrigen);

  var contadorFilas = 0;

  // Comenzar desde la fila 3 y recorrer hasta encontrar la primera fila vac√≠a
  for (var fila = 3; fila <= ultimaFilaOrigen; fila++) {
    // Verificar si la celda en la columna A de la fila actual est√° vac√≠a
    var valorCelda = hojaOrigen.getRange(fila, 1).getValue();
    if (valorCelda === '') {
      // Si la celda est√° vac√≠a, detener el bucle //BUCLE DE ABIETA
      break;
    }

    // Si la celda no est√° vac√≠a, realizar operaciones con la fila actual
    var datosFila1 = hojaOrigen.getRange(fila, 1, 1, 5).getValues()[0];
    var datosFila2 = hojaOrigen.getRange(fila, 8, 1, 1).getValue();
    var datosRepetir = ["ABIERTO"].concat(datosARepetir[0], datosFila1, [""], datosFila2, [""]);

    // Verificar si hay informaci√≥n en la fila
    if (datosRepetir.some(function (valor) { return valor !== ''; })) {
      // Incrementar el contador de filas
      contadorFilas++;

      // Realizar operaciones adicionales con datosRepetir si hay informaci√≥n
      for (var i = 0; i < datosRepetir.length; i++) {
        // Puedes realizar operaciones adicionales con cada elemento de datosRepetir si es necesario
        var datosFila = datosRepetir[i];
        Logger.log("Datos repetidos: " + datosFila);
      }

      // Insertar una nueva fila despu√©s de la √∫ltima fila con valores
      hojaDestino.insertRowAfter(ultimaFilaDestino);

      // Pegar los datos en la hoja de destino (por ejemplo, columnas C:M)
      hojaDestino.getRange(ultimaFilaDestino + 1, 1, 1, datosRepetir.length).setValues([datosRepetir]);

      // Obt√©n el valor de las f√≥rmulas
      var formulas = rangoFormulas.getFormulasR1C1()[0];

      // Obt√©n la √∫ltima fila con datos en la hoja
      var ultimaFila = ultimaFilaDestino;

      // Establece el rango de celdas en el que deseas copiar las f√≥rmulas
      var rangoDestino = hojaDestino.getRange(ultimaFila + 1, 11, 1, formulas.length);

      // Establece las f√≥rmulas en el nuevo rango
      rangoDestino.setFormulasR1C1([formulas]);

      // Actualizar la variable ultimaFilaDestino para reflejar la nueva √∫ltima fila
      ultimaFilaDestino = hojaDestino.getLastRow();
    } else {
      Logger.log("No hay informaci√≥n en datosRepetir");
    }
  }

  // Hacer algo con el contadorFilas, si es necesario
  Logger.log("N√∫mero total de filas procesadas: " + contadorFilas);
}


function recorrerColumnaCompletado(hojaOrigenNombre) {//funciona refunciona == COMPLETADO
  // Obtener la hoja de c√°lculo activa y la columna A
  var hoja = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(hojaOrigenNombre);
  var hojaDestino = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("CONCENTRADO");

  var ultimaFilaOrigen = hoja.getLastRow();
  var ultimaFilaDestino = hojaDestino.getLastRow();

  // Obtener los valores en la columna A
  var valoresColumnaA = hoja.getRange("A:A").getValues();

  // Definir el rango de celdas con f√≥rmulas en la hoja de origen (por ejemplo, K42:N42)
  var rangoFormulas = hojaDestino.getRange("K2:N2"); // RANGO DE ABIERTA

  // Recorrer la columna A
  for (var i = 0; i < valoresColumnaA.length; i++) {
    if (valoresColumnaA[i][0] !== "") { // Verificar si la celda no est√° vac√≠a
      var cadena = valoresColumnaA[i][0];
      var partes = cadena.split('-');

      // Verificar si split gener√≥ al menos dos partes y la segunda parte es igual a 'COMPLETED ITEMS'
      if (partes.length >= 2 && partes[1].trim() === 'COMPLETED ITEMS') {
        var titulo = partes[0].trim();

        Logger.log("Fila " + (i + 1) + ", Valor: " + titulo);
        
        for (var fila = i + 3; fila <= ultimaFilaOrigen; fila++) { // Comenzar desde la tercera fila
          var valorCelda = hoja.getRange(fila, 1).getValue();
          if (valorCelda === '') {
            // Si la celda est√° vac√≠a, detener el bucle
            break;
          }
          Logger.log("Fila en la que estamos: " + (fila + 1));

          // Si la celda no est√° vac√≠a, realizar operaciones con la fila actual
          var datosFila1 = hoja.getRange(fila, 1, 1, 8).getValues()[0];

          var datosRepetir = ["COMPLETADO"].concat(titulo, datosFila1, [""]);

          // Verificar si hay informaci√≥n en la fila
          if (datosRepetir.some(function (valor) { return valor !== ''; })) {
            // Realizar operaciones adicionales con datosRepetir si hay informaci√≥n
            for (var j = 0; j < datosRepetir.length; j++) {
              // Puedes realizar operaciones adicionales con cada elemento de datosRepetir si es necesario
              var datosFila = datosRepetir[j];
              Logger.log("Datos repetidos: " + datosFila);
            }

            // Insertar una nueva fila despu√©s de la √∫ltima fila con valores
            hojaDestino.insertRowAfter(ultimaFilaDestino);

            // Pegar los datos en la hoja de destino (por ejemplo, columnas C:M)
            hojaDestino.getRange(ultimaFilaDestino + 1, 1, 1, datosRepetir.length).setValues([datosRepetir]);

            // Obt√©n el valor de las f√≥rmulas
            var formulas = rangoFormulas.getFormulasR1C1()[0];

            // Obt√©n la √∫ltima fila con datos en la hoja
            var ultimaFila = ultimaFilaDestino;

            // Establece el rango de celdas en el que deseas copiar las f√≥rmulas
            var rangoDestino = hojaDestino.getRange(ultimaFila + 1, 11, 1, formulas.length);

            // Establece las f√≥rmulas en el nuevo rango
            rangoDestino.setFormulasR1C1([formulas]);

            // Actualizar la variable ultimaFilaDestino para reflejar la nueva √∫ltima fila
            ultimaFilaDestino = hojaDestino.getLastRow();

          } else {
            Logger.log("No hay informaci√≥n en datosRepetir");
          }
        }
      }
    }
  }
}

///complemento de filas abiertas///
function obtenerDatosAbiertas(hojaOrigen) {
  var datosOrigen = hojaOrigen.getRange("A1:C1").getValues()[0];

  if (datosOrigen.length > 0) {
    var cadenas = obtenerCadena(datosOrigen);
    return cadenas;
  } else {
    Logger.log("La fila de origen no contiene valores.");
    return null;
  }
}

// Funci√≥n para obtener las cadenas antes y despu√©s del "-"//saca un solo valor
function obtenerCadena(datos) {
  if (datos.length > 0) {
    var cadena = datos[0]; // Obtener el valor de la columna A (por ejemplo)
    var partes = cadena.split('-');
    return [[partes[0].trim()]];
    //return [[partes[0].trim(), partes[1].trim()]];
  } else {
    // Devolver un array vac√≠o si no hay valores
    return [];
  }
}

////funcion de eliminar todo de una hoja///
function funcionEliminarTodo() {
    eliminarDatosDeHoja("Consejo 2024- ifno");
    eliminarDatosDeHoja("Rosca de reyes DESPACHO - info");
    eliminarDatosDeHoja("Regalos Navidad 2024- info");
    eliminarDatosDeHoja("Organizar Evento Dia de Reyes 06 Enero 2024- info");
    eliminarDatosDeHoja("Propuesta Detalle Cumplea√±os mensual- info");
}

function eliminarDatosDeHoja(nombreHoja) {
 // var hoja = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var hoja = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(nombreHoja);
  
  // Obtener el rango de todas las celdas con datos en la hoja
  var rango = hoja.getDataRange();
  
  // Limpiar el contenido del rango (eliminar todos los datos)
  rango.clearContent();
}
